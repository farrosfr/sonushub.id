gas---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import FilterSidebar from '../components/FilterSidebar.astro';
import Pagination from '../components/Pagination.astro';
import { pool } from '../lib/db';
import type { Product } from '../data/products';

// --- Pagination Logic ---
const PAGE_SIZE = 12;
const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const offset = (page - 1) * PAGE_SIZE;

// --- Logic untuk Filtering ---
const searchParams = Astro.url.searchParams;

const categories = searchParams.getAll('kategori');
const brands = searchParams.getAll('brand');
const minPrice = searchParams.get('min_price');
const maxPrice = searchParams.get('max_price');

let products: Product[] = [];
let totalProducts = 0;
let totalPages = 1;
let error: string | null = null;

try {
  let sql = 'SELECT id, name, price, imageUrl, description, slug, kategori, brand FROM products';
  let countSql = 'SELECT COUNT(*) as count FROM products';
  const conditions: string[] = [];
  const params: (string | number | (string | number)[])[] = [];
  const countParams: (string | number | (string | number)[])[] = [];

  if (categories.length > 0) {
    conditions.push('kategori IN (?)');
    params.push(categories);
    countParams.push(categories);
  }

  if (brands.length > 0) {
    conditions.push('brand IN (?)');
    params.push(brands);
    countParams.push(brands);
  }

  if (minPrice) {
    conditions.push('price >= ?');
    params.push(Number(minPrice));
    countParams.push(Number(minPrice));
  }

  if (maxPrice) {
    conditions.push('price <= ?');
    params.push(Number(maxPrice));
    countParams.push(Number(maxPrice));
  }

  if (conditions.length > 0) {
    const whereClause = ' WHERE ' + conditions.join(' AND ');
    sql += whereClause;
    countSql += whereClause;
  }

  // Get total count
  const [countRows] = await pool.query(countSql, countParams);
  totalProducts = (countRows as any)[0].count;
  totalPages = Math.ceil(totalProducts / PAGE_SIZE);

  // Get paginated products
  sql += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
  params.push(PAGE_SIZE, offset);

  const [rows] = await pool.query(sql, params);
  
  products = (rows as any[]).map(row => ({
    ...row,
    id: String(row.id),
  }));

} catch (e: any) {
  console.error(e);
  error = "Tidak dapat memuat produk. Silakan coba lagi nanti.";
}
---

<Layout title="Katalog Lengkap">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold text-center mb-12 text-gray-900 dark:text-white">Katalog Produk Lengkap</h1>
    
    <div class="flex flex-col md:flex-row gap-8">
      <FilterSidebar 
        currentCategories={categories}
        currentBrands={brands}
        minPrice={minPrice || ''}
        maxPrice={maxPrice || ''}
      />

      <div class="w-full">
        {error && (
          <div class="text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline"> {error}</span>
          </div>
        )}

        {!error && products.length === 0 && (
          <div class="text-center p-10 border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Tidak Ada Produk Ditemukan</h3>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Coba ubah atau reset filter Anda untuk melihat lebih banyak produk.</p>
            <a href="/katalog" class="mt-4 inline-block bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                Reset Semua Filter
            </a>
          </div>
        )}

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {
            products.map(product => (
              <ProductCard product={product} />
            ))
          }
        </div>

        <Pagination
          currentPage={page}
          totalPages={totalPages}
          baseUrl={Astro.url.pathname}
          searchParams={Astro.url.searchParams}
        />
      </div>
    </div>
  </main>
</Layout>
