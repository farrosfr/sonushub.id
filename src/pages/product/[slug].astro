---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/ProductCard.astro';
import { pool } from '../../lib/db';
import type { Product } from '../../data/products';

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/placeholders/*.{jpeg,jpg,png,gif,webp}');

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

let product: Product | null = null;
let error: string | null = null;

try {
  const [rows] = await pool.query('SELECT id, name, price, imageUrl, description, slug, kategori, brand FROM products WHERE slug = ?', [slug]);
  const productResult = (rows as any[])[0];

  if (productResult) {
    product = {
      ...productResult,
      id: String(productResult.id),
    };
  } else {
    return Astro.redirect('/404');
  }
} catch (e: any) {
  console.error(e);
  error = "Tidak dapat memuat produk. Silakan coba lagi nanti.";
}

const formattedPrice = product ? new Intl.NumberFormat('id-ID', {
  style: 'currency',
  currency: 'IDR',
  minimumFractionDigits: 0,
}).format(product.price) : '';

let relatedProducts: Product[] = [];
if (product) {
  try {
    const [relatedRows] = await pool.query(
      'SELECT id, name, price, imageUrl, description, slug, kategori, brand FROM products WHERE kategori = ? AND slug != ? ORDER BY created_at DESC LIMIT 4',
      [product.kategori, product.slug]
    );
    relatedProducts = (relatedRows as any[]).map(row => ({
      ...row,
      id: String(row.id),
    }));
  } catch (e) {
    console.error('Error fetching related products:', e);
  }
}
const isExternalUrl = product.imageUrl && product.imageUrl.startsWith('http');
const localImage = product.imageUrl && images[`/src/assets/placeholders/${product.imageUrl}`];
---

<Layout title={product?.name || 'Detail Produk'}>
  <main class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto pl-0 pr-0 md:pl-8 md:pr-8">
      <a href="/katalog" class="text-blue-600 dark:text-blue-400 hover:underline mb-6 inline-block">&larr; Kembali ke Katalog</a>

      {error && (
        <div class="text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
          <strong class="font-bold">Error!</strong>
          <span class="block sm:inline"> {error}</span>
        </div>
      )}

      {product && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            { isExternalUrl ? (
              <img src={product.imageUrl} alt={`Gambar ${product.name}`} loading="lazy" class="w-full h-auto rounded-lg shadow-md" />
            ) : localImage ? (
              <Image 
                src={localImage()} 
                alt={`Gambar ${product.name}`} 
                width={800} 
                height={800} 
                class="w-full h-auto rounded-lg shadow-md"
                loading="eager"
              />
            ) : (
              <div class="w-full h-[800px] rounded-lg shadow-md bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                <span class="text-gray-500 dark:text-gray-400">Gambar tidak tersedia</span>
              </div>
            )}
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{product.name}</h1>
            {product.kategori && product.brand && (
              <div class="text-md text-gray-600 dark:text-gray-400 mt-2">
                <a href={`/kategori/${product.kategori.toLowerCase().replace(/\s+/g, '-')}`} class="hover:underline">{product.kategori}</a>
                <span class="mx-1">&bull;</span>
                <a href={`/merk/${product.brand.toLowerCase().replace(/\s+/g, '-')}`} class="hover:underline">{product.brand}</a>
              </div>
            )}
            <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 my-4">{formattedPrice}</p>
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mt-6 mb-2">Deskripsi Produk</h2>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed" set:html={product.description}></p>

            <div class="mt-8 flex flex-col sm:flex-row gap-4">
              <button id="openRfqModal" class="w-full sm:w-auto flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                Minta Penawaran
              </button>
              <a href="#" class="w-full sm:w-auto flex-1 flex items-center justify-center gap-2 border border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400 hover:bg-blue-50 dark:hover:bg-gray-800 hover:text-blue-700 font-bold py-3 px-4 rounded-lg transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Unduh Datasheet
              </a>
            </div>
          </div>
        </div>
      )}

      {relatedProducts.length > 0 && (
        <section class="mt-12">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">Produk Terkait</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {relatedProducts.map(p => (
              <ProductCard product={p} />
            ))}
          </div>
        </section>
      )}
    </div>
  </main>

  <!-- RFQ Modal -->
  <div id="rfqModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 md:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800 dark:border-gray-700">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Minta Penawaran untuk {product?.name}</h3>
        <div class="mt-2 px-7 py-3">
          <form id="rfqForm" class="space-y-6">
            <input type="hidden" id="rfqProductId" value={product?.id} />
            <input type="hidden" id="rfqProductName" value={product?.name} />

            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="quantity" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Kuantitas</label>
              <input type="number" id="quantity" name="quantity" min="1" value="1" required
                     class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent">
            </div>
            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="customerName" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Nama Anda</label>
              <input type="text" id="customerName" name="customerName" required
                     class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent">
            </div>
            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="companyName" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Nama Perusahaan (Opsional)</label>
              <input type="text" id="companyName" name="companyName"
                     class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent">
            </div>
            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="email" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Email</label>
              <input type="email" id="email" name="email" required
                     class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent">
            </div>
            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="phone" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Nomor Telepon (WhatsApp)</label>
              <input type="tel" id="phone" name="phone" required
                     class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent">
            </div>
            <div class="relative border border-gray-300 dark:border-gray-600 rounded-lg focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
              <label for="message" class="absolute -top-3 left-3 -mt-px inline-block bg-white dark:bg-gray-800 px-1 text-xs font-medium text-gray-900 dark:text-gray-300">Pesan / Persyaratan Tambahan (Opsional)</label>
              <textarea id="message" name="message" rows="3"
                        class="block w-full border-0 p-3 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 sm:text-sm bg-transparent"></textarea>
            </div>
            <div id="rfqMessage" class="text-center mt-4 text-sm"></div>
            <div class="items-center px-4 py-3">
              <button id="submitRfq" type="submit"
                      class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Kirim Permintaan
              </button>
              <button id="closeRfqModal" type="button"
                      class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Batal
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Script block is running!'); // Added for debugging
    const openRfqModalBtn = document.getElementById('openRfqModal');
    const rfqModal = document.getElementById('rfqModal');
    const closeRfqModalBtn = document.getElementById('closeRfqModal');
    const rfqForm = document.getElementById('rfqForm');
    const rfqMessage = document.getElementById('rfqMessage');

    console.log('openRfqModalBtn:', openRfqModalBtn); // Added for debugging

    openRfqModalBtn?.addEventListener('click', () => {
      rfqModal.classList.remove('hidden');
    });

    closeRfqModalBtn?.addEventListener('click', () => {
      rfqModal.classList.add('hidden');
      rfqMessage.textContent = ''; // Clear messages on close
      rfqForm.reset(); // Reset form fields
    });

    rfqModal?.addEventListener('click', (event) => {
      if (event.target === rfqModal) {
        rfqModal.classList.add('hidden');
        rfqMessage.textContent = ''; // Clear messages on close
        rfqForm.reset(); // Reset form fields
      }
    });

    rfqForm?.addEventListener('submit', async (event) => {
      event.preventDefault();

      rfqMessage.textContent = 'Mengirim...';
      rfqMessage.className = 'text-center mt-4 text-sm text-gray-600 dark:text-gray-300';

      const productId = document.getElementById('rfqProductId')?.value;
      const productName = document.getElementById('rfqProductName')?.value;
      const quantity = parseInt(document.getElementById('quantity')?.value || '0');
      const customerName = document.getElementById('customerName')?.value;
      const companyName = document.getElementById('companyName')?.value;
      const email = document.getElementById('email')?.value;
      const phone = document.getElementById('phone')?.value;
      const message = document.getElementById('message')?.value;

      try {
        const response = await fetch('/api/rfq', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            productId,
            productName,
            quantity,
            customerName,
            companyName,
            email,
            phone,
            message,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          rfqMessage.textContent = 'Permintaan penawaran berhasil dikirim! Kami akan segera menghubungi Anda.';
          rfqMessage.className = 'text-center mt-4 text-sm text-green-600';
          rfqForm.reset();
          // Optionally close modal after a delay
          setTimeout(() => {
            rfqModal.classList.add('hidden');
            rfqMessage.textContent = '';
          }, 3000);
        } else {
          rfqMessage.textContent = `Gagal mengirim permintaan: ${result.message || 'Terjadi kesalahan.'}`;
          rfqMessage.className = 'text-center mt-4 text-sm text-red-600';
        }
      } catch (error) {
        console.error('Error submitting RFQ form:', error);
        rfqMessage.textContent = 'Terjadi kesalahan jaringan atau server. Silakan coba lagi.';
        rfqMessage.className = 'text-center mt-4 text-sm text-red-600';
      }
    });
  });
</script>