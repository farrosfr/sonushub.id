---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import type { Product } from '../data/products';

interface Props {
  product: Product;
}

const { product } = Astro.props;
const formattedPrice = new Intl.NumberFormat('id-ID', {
  style: 'currency',
  currency: 'IDR',
  minimumFractionDigits: 0,
}).format(product.price);

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/placeholders/*.{jpeg,jpg,png,gif,webp}');
const isExternalUrl = product.imageUrl && product.imageUrl.startsWith('http');
const localImage = product.imageUrl && images[`/src/assets/placeholders/${product.imageUrl}`];
---

<div class="border rounded-lg shadow-md overflow-hidden bg-white dark:bg-gray-800 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300 flex flex-col">
  <a href={`/product/${product.slug}`}>
    { isExternalUrl ? (
      <img src={product.imageUrl} alt={`Gambar ${product.name}`} loading="lazy" class="w-full aspect-square object-cover" />
    ) : localImage ? (
      <Image 
        src={localImage()} 
        alt={`Gambar ${product.name}`} 
        width={400} 
        height={400} 
        class="w-full aspect-square object-cover"
        loading="eager"
      />
    ) : (
      <div class="w-full aspect-square bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
        <span class="text-gray-500 dark:text-gray-400">Gambar tidak tersedia</span>
      </div>
    )}
  </a>
  <div class="p-4 flex flex-col flex-grow">
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate" title={product.name}>
      <a href={`/product/${product.slug}`} class="hover:text-blue-600 dark:hover:text-blue-400">{product.name}</a>
    </h3>
    <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
      {product.kategori && (
        <a href={`/kategori/${product.kategori.toLowerCase().replace(/\s+/g, '-')}`} class="hover:underline">{product.kategori}</a>
      )}
      {product.kategori && product.brand && <span class="mx-1">&bull;</span>}
      {product.brand && (
        <a href={`/merk/${product.brand.toLowerCase().replace(/\s+/g, '-')}`} class="hover:underline">{product.brand}</a>
      )}
    </div>
    <div class="mt-auto pt-2">
      <p class="text-xl font-bold text-gray-900 dark:text-white">{formattedPrice}</p>
    </div>
  </div>
</div>
